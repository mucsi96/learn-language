@if(pageNumber()) {
<div class="page-nav">
  <a
    mat-icon-button
    [routerLink]="[
      '/sources',
      selectedSourceId(),
      'page',
      (pageNumber() ?? 0) - 1
    ]"
    aria-label="Previous page"
    ><mat-icon>arrow_back_ios_new</mat-icon></a
  >
  <mat-form-field>
    <mat-label>Page</mat-label>
    <input
      matInput
      type="number"
      [(ngModel)]="pageNumber"
      (change)="onPageChange()"
    />
  </mat-form-field>
  <a
    mat-icon-button
    [routerLink]="[
      '/sources',
      selectedSourceId(),
      'page',
      (pageNumber() ?? 0) + 1
    ]"
    aria-label="Next page"
    ><mat-icon>arrow_forward_ios</mat-icon></a
  >
  @if (sourceType() === 'images' && hasImage()) {
  <button mat-icon-button aria-label="Delete image" (click)="deleteImage()">
    <mat-icon>delete</mat-icon>
  </button>
  }
</div>
} @if (pageLoading()) {
<mat-spinner class="page-loading" />
} @else if (isEmptyImageSource()) {
<div
  class="image-dropzone"
  role="region"
  aria-label="Image upload dropzone"
  [class.dragging]="isDragging()"
  (dragover)="onDragOver($event)"
  (dragleave)="onDragLeave($event)"
  (drop)="onDrop($event)"
>
  @if (uploading()) {
  <mat-spinner></mat-spinner>
  } @else {
  <mat-icon class="upload-icon">add_photo_alternate</mat-icon>
  <p class="dropzone-text">
    Drag and drop an image here or
    <label class="file-input-label">
      browse
      <input
        type="file"
        accept=".png,.jpg,.jpeg,.gif,.webp"
        (change)="onImageFileSelected($event)"
        class="hidden-file-input"
        aria-label="Upload image file"
      />
    </label>
  </p>
  <p class="dropzone-hint">PNG, JPG, JPEG, GIF, WEBP</p>
  }
  @if (uploadError()) {
  <p class="error-message">{{ uploadError() }}</p>
  }
</div>
} @else {
<section
  class="page-layout"
  role="region"
  aria-label="Page content"
  appDraggableSelection
  (selectionBox)="onSelection($event)"
  [style.height]="heightStyle"
  [attr.data-ready]="isReady()"
  [style.background-image]="documentImage.value() ? 'url(' + documentImage.value() + ')' : 'none'"
  [style.background-size]="'100% 100%'"
>
  @if (selectionRegionsLoading()) {
  <div class="area-loading">
    <mat-spinner></mat-spinner>
  </div>
  }
  @for (rect of selectedRectangles(); track $index) {
  <div
    class="selection-rectangle"
    [class.grouped]="rect.isGrouped"
    [class.pending]="rect.isPending"
    [style.left]="'calc(var(--page-width) * ' + rect.x + ')'"
    [style.top]="'calc(var(--page-width) * ' + rect.y + ')'"
    [style.width]="'calc(var(--page-width) * ' + rect.width + ')'"
    [style.height]="'calc(var(--page-width) * ' + rect.height + ')'"
    [attr.data-group]="rect.groupIndex"
  >
    @if (rect.isPending) {
    <span class="group-badge">{{ rect.groupIndex + 1 }}</span>
    }
  </div>
  }
  @for (span of spans(); track $index) {
  <app-span
    [sourceId]="selectedSourceId()"
    [pageNumber]="pageNumber()"
    [text]="span.text"
    [bbox]="span.bbox"
    [font]="span.font"
    [color]="span.color"
    [fontSize]="span.fontSize"
    [searchTerm]="span.searchTerm"
    [selectionRegions]="selectionRegions()"
  ></app-span>
  }
</section>

@if (hasPendingSelection()) {
<div class="pending-selection-actions" role="region" aria-label="Selection actions">
  <button mat-fab extended color="primary" (click)="confirmSelection()" aria-label="Extract text from selection">
    <mat-icon>check</mat-icon>
    Extract
  </button>
  <button mat-fab extended (click)="cancelSelection()" aria-label="Cancel selection">
    <mat-icon>close</mat-icon>
    Cancel
  </button>
</div>
}

@if (formatType() === 'flowingText' && extractedCandidates().length > 0) {
<div class="extracted-candidates-container" role="region" aria-label="Extracted items">
  <mat-chip-set>
    @for (item of extractedCandidates(); track item.id) {
    <button mat-chip [matMenuTriggerFor]="itemMenu">
      {{ candidatesService.getItemLabel(item) }}
    </button>
    <mat-menu #itemMenu="matMenu">
      <button mat-menu-item (click)="addToKnownWords(candidatesService.getItemLabel(item), item.id)">
        <mat-icon>check_circle</mat-icon>
        <span>Add to known words</span>
      </button>
      <button mat-menu-item (click)="ignoreItem(item.id)">
        <mat-icon>visibility_off</mat-icon>
        <span>Ignore once</span>
      </button>
    </mat-menu>
    }
  </mat-chip-set>
</div>
}

<app-bulk-card-creation-fab></app-bulk-card-creation-fab>
}
