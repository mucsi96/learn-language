@if (loading()) {
<div class="container">
  <h1>Model Usage Logs</h1>
  <p>Track AI model usage and costs across chat, image, and audio services.</p>

  <table mat-table [dataSource]="skeletonData" class="usage-table">
    <ng-container matColumnDef="expand">
      <th mat-header-cell *matHeaderCellDef></th>
      <td mat-cell *matCellDef="let log">
        <div class="skeleton skeleton-icon"></div>
      </td>
    </ng-container>

    <ng-container matColumnDef="createdAt">
      <th mat-header-cell *matHeaderCellDef>Time</th>
      <td mat-cell *matCellDef="let log">
        <div class="skeleton skeleton-text-medium"></div>
      </td>
    </ng-container>

    <ng-container matColumnDef="modelType">
      <th mat-header-cell *matHeaderCellDef>Type</th>
      <td mat-cell *matCellDef="let log">
        <div class="skeleton skeleton-text-small"></div>
      </td>
    </ng-container>

    <ng-container matColumnDef="modelName">
      <th mat-header-cell *matHeaderCellDef>Model</th>
      <td mat-cell *matCellDef="let log">
        <div class="skeleton skeleton-text-medium"></div>
      </td>
    </ng-container>

    <ng-container matColumnDef="operationType">
      <th mat-header-cell *matHeaderCellDef>Operation</th>
      <td mat-cell *matCellDef="let log">
        <div class="skeleton skeleton-text-medium"></div>
      </td>
    </ng-container>

    <ng-container matColumnDef="usage">
      <th mat-header-cell *matHeaderCellDef>Usage</th>
      <td mat-cell *matCellDef="let log">
        <div class="skeleton skeleton-text-medium"></div>
      </td>
    </ng-container>

    <ng-container matColumnDef="diff">
      <th mat-header-cell *matHeaderCellDef>Diff</th>
      <td mat-cell *matCellDef="let log">
        <div class="skeleton skeleton-text-small"></div>
      </td>
    </ng-container>

    <ng-container matColumnDef="cost">
      <th mat-header-cell *matHeaderCellDef>Per $1</th>
      <td mat-cell *matCellDef="let log">
        <div class="skeleton skeleton-text-small"></div>
      </td>
    </ng-container>

    <ng-container matColumnDef="time">
      <th mat-header-cell *matHeaderCellDef>Seconds</th>
      <td mat-cell *matCellDef="let log">
        <div class="skeleton skeleton-text-small"></div>
      </td>
    </ng-container>

    <ng-container matColumnDef="rating">
      <th mat-header-cell *matHeaderCellDef>Rating</th>
      <td mat-cell *matCellDef="let log">
        <div class="skeleton skeleton-text-medium"></div>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
  </table>
</div>
} @else {
<div class="container">
  <h1>Model Usage Logs</h1>
  <p>Track AI model usage and costs across chat, image, and audio services.</p>

  @let logsList = logs() || [];
  @let dateOptions = availableDates();
  @let modelTypes = availableModelTypes();
  @let operationTypes = availableOperationTypes();
  @let modelNames = availableModelNames();
  @let rows = flatLogRows();

  <mat-tab-group>
    <mat-tab label="Usage Logs">
      <div class="tab-content">
        @if (hasAnyLogs()) {
        <div class="filters-section">
          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>Date</mat-label>
            <mat-select [value]="dateFilter()" (selectionChange)="onDateFilterChange($event.value)" aria-label="Filter by date">
              <mat-option value="ALL">All dates</mat-option>
              @for (option of dateOptions; track option.value) {
                <mat-option [value]="option.value">{{ option.label }}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>Type</mat-label>
            <mat-select [value]="modelTypeFilter()" (selectionChange)="onModelTypeFilterChange($event.value)" aria-label="Filter by type">
              <mat-option value="ALL">All types</mat-option>
              @for (type of modelTypes; track type) {
                <mat-option [value]="type">{{ type }}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>Operation</mat-label>
            <mat-select [value]="operationTypeFilter()" (selectionChange)="onOperationTypeFilterChange($event.value)" aria-label="Filter by operation">
              <mat-option value="ALL">All operations</mat-option>
              @for (op of operationTypes; track op) {
                <mat-option [value]="op">{{ op }}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>Model</mat-label>
            <mat-select [value]="modelNameFilter()" (selectionChange)="onModelNameFilterChange($event.value)" aria-label="Filter by model">
              <mat-option value="ALL">All models</mat-option>
              @for (name of modelNames; track name) {
                <mat-option [value]="name">{{ name }}</mat-option>
              }
            </mat-select>
          </mat-form-field>
        </div>
        }

        @if (logsList.length > 0) {
        <div class="summary-card">
          <span class="summary-label">Total Cost:</span>
          <span class="summary-value">${{ totalCost() | number: '1.4-4' }}</span>
          @if (canDelete()) {
          <button mat-icon-button
                  class="clear-logs-button"
                  (click)="clearLogs()"
                  aria-label="Clear logs"
                  matTooltip="Clear filtered logs">
            <mat-icon>delete_outline</mat-icon>
          </button>
          }
        </div>

        <table mat-table [dataSource]="rows" multiTemplateDataRows class="usage-table">
          <ng-container matColumnDef="expand">
            <th mat-header-cell *matHeaderCellDef></th>
            <td mat-cell *matCellDef="let row">
              @if (hasContent(row.log)) {
              <button mat-icon-button (click)="toggleExpand(row.log); $event.stopPropagation()" [aria-label]="isExpanded(row.log) ? 'Collapse' : 'Expand'">
                <mat-icon>{{ isExpanded(row.log) ? 'expand_less' : 'expand_more' }}</mat-icon>
              </button>
              }
            </td>
          </ng-container>

          <ng-container matColumnDef="createdAt">
            <th mat-header-cell *matHeaderCellDef>Time</th>
            <td mat-cell *matCellDef="let row">
              {{ row.log.createdAt | date: 'short' }}
            </td>
          </ng-container>

          <ng-container matColumnDef="modelType">
            <th mat-header-cell *matHeaderCellDef>Type</th>
            <td mat-cell *matCellDef="let row">
              <mat-icon class="type-icon">{{ getModelTypeIcon(row.log.modelType) }}</mat-icon>
              <span class="type-label">{{ row.log.modelType }}</span>
            </td>
          </ng-container>

          <ng-container matColumnDef="modelName">
            <th mat-header-cell *matHeaderCellDef>Model</th>
            <td mat-cell *matCellDef="let row">
              <span class="model-name">{{ row.log.modelName }}</span>
              @if (isPrimaryLog(row.log, row.group) && row.isGrouped) {
                <span class="primary-badge">primary</span>
              }
            </td>
          </ng-container>

          <ng-container matColumnDef="operationType">
            <th mat-header-cell *matHeaderCellDef>Operation</th>
            <td mat-cell *matCellDef="let row">
              {{ row.log.operationType }}
            </td>
          </ng-container>

          <ng-container matColumnDef="usage">
            <th mat-header-cell *matHeaderCellDef>Usage</th>
            <td mat-cell *matCellDef="let row">
              {{ getUsageDisplay(row.log) }}
            </td>
          </ng-container>

          <ng-container matColumnDef="diff">
            <th mat-header-cell *matHeaderCellDef>Diff</th>
            <td mat-cell *matCellDef="let row">
              @let diffSummary = getDiffSummaryForLog(row.log, row.group);
              @if (diffSummary) {
                <span class="diff-summary">
                  @if (diffSummary.additions > 0) {
                    <span class="diff-additions">+{{ diffSummary.additions }}</span>
                  }
                  @if (diffSummary.deletions > 0) {
                    <span class="diff-deletions">-{{ diffSummary.deletions }}</span>
                  }
                  @if (diffSummary.additions === 0 && diffSummary.deletions === 0) {
                    <span class="diff-identical">identical</span>
                  }
                </span>
              }
            </td>
          </ng-container>

          <ng-container matColumnDef="cost">
            <th mat-header-cell *matHeaderCellDef>Per $1</th>
            <td mat-cell *matCellDef="let row">
              <span class="cost-value">{{ getPerDollarCount(row.log) }}</span>
            </td>
          </ng-container>

          <ng-container matColumnDef="time">
            <th mat-header-cell *matHeaderCellDef>Seconds</th>
            <td mat-cell *matCellDef="let row">
              {{ getDurationSeconds(row.log) }}
            </td>
          </ng-container>

          <ng-container matColumnDef="rating">
            <th mat-header-cell *matHeaderCellDef>Rating</th>
            <td mat-cell *matCellDef="let row">
              @if (isRatable(row.log)) {
                <div class="rating-stars">
                  @for (star of ratingStars; track star) {
                    <button mat-icon-button
                            class="star-button"
                            (click)="setRating(row.log, star, $event)"
                            [attr.aria-label]="'Rate ' + star + ' stars'">
                      <mat-icon [class]="getStarClass(row.log, star)">
                        {{ row.log.rating && star <= row.log.rating ? 'star' : 'star_border' }}
                      </mat-icon>
                    </button>
                  }
                </div>
              }
            </td>
          </ng-container>

          <ng-container matColumnDef="expandedDetail">
            <td mat-cell *matCellDef="let row" [attr.colspan]="displayedColumns.length">
              @if (isExpanded(row.log)) {
              <div class="expanded-content">
                @if (row.log.responseContent) {
                @let diffLines = getDiffLines(row.log, row.group);
                <div class="content-section">
                  <div class="content-header">
                    @if (diffLines.length > 0) {
                      <h3>Diff vs Primary</h3>
                    } @else {
                      <h3>Response</h3>
                    }
                    <button mat-icon-button
                            class="copy-button"
                            (click)="copyToClipboard(row.log.responseContent); $event.stopPropagation()"
                            aria-label="Copy to clipboard"
                            matTooltip="Copy to clipboard">
                      <mat-icon>content_copy</mat-icon>
                    </button>
                  </div>
                  @if (diffLines.length > 0) {
                    <div class="content-pre diff-view">
                      @for (line of diffLines; track $index) {
                        <div [class]="'diff-line diff-' + line.type">{{ line.type === 'added' ? '+' : line.type === 'removed' ? '-' : ' ' }} {{ line.content }}</div>
                      }
                    </div>
                  } @else {
                    <pre class="content-pre">{{ row.log.responseContent }}</pre>
                  }
                </div>
                }
              </div>
              }
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"
              [class.expandable-row]="hasContent(row.log)"
              [class.grouped-row]="row.isGrouped"
              [class.group-first]="row.isFirst && row.isGrouped"
              (click)="toggleExpand(row.log)"></tr>
          <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail-row"></tr>
        </table>
        } @else if (hasAnyLogs()) {
        <mat-card class="empty-state">
          <mat-card-content>
            <mat-icon class="empty-icon">filter_list</mat-icon>
            <h2>No matching logs</h2>
            <p>No logs match the selected filters. Try adjusting your filters.</p>
          </mat-card-content>
        </mat-card>
        } @else {
        <mat-card class="empty-state">
          <mat-card-content>
            <mat-icon class="empty-icon">analytics</mat-icon>
            <h2>No usage logs yet</h2>
            <p>Usage logs will appear here once AI models are used.</p>
          </mat-card-content>
        </mat-card>
        }
      </div>
    </mat-tab>

    <mat-tab label="Model Summary">
      <div class="tab-content">
        @let groups = groupedSummary();
        @if (groups.length > 0) {
          @for (group of groups; track group.operationType) {
            <h3 class="operation-type-heading">{{ group.operationType }}</h3>
            <table mat-table [dataSource]="group.summaries" class="summary-table" [attr.aria-label]="group.operationType + ' summary'">
              <ng-container matColumnDef="modelName">
                <th mat-header-cell *matHeaderCellDef>Model</th>
                <td mat-cell *matCellDef="let row">
                  <span class="model-name">{{ row.modelName }}</span>
                </td>
              </ng-container>

              <ng-container matColumnDef="totalCalls">
                <th mat-header-cell *matHeaderCellDef>Total Calls</th>
                <td mat-cell *matCellDef="let row">{{ row.totalCalls }}</td>
              </ng-container>

              <ng-container matColumnDef="ratedCalls">
                <th mat-header-cell *matHeaderCellDef>Rated Calls</th>
                <td mat-cell *matCellDef="let row">{{ row.ratedCalls }}</td>
              </ng-container>

              <ng-container matColumnDef="averageRating">
                <th mat-header-cell *matHeaderCellDef>Avg Rating</th>
                <td mat-cell *matCellDef="let row">
                  @if (row.ratedCalls > 0) {
                    <div class="avg-rating">
                      <mat-icon class="star-filled">star</mat-icon>
                      <span>{{ row.averageRating | number: '1.2-2' }}</span>
                    </div>
                  } @else {
                    <span class="no-rating">-</span>
                  }
                </td>
              </ng-container>

              <ng-container matColumnDef="totalCost">
                <th mat-header-cell *matHeaderCellDef>Total Cost</th>
                <td mat-cell *matCellDef="let row">
                  <span class="cost-value">${{ row.totalCost | number: '1.4-4' }}</span>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="summaryColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: summaryColumns"></tr>
            </table>
          }
        } @else {
        <mat-card class="empty-state">
          <mat-card-content>
            <mat-icon class="empty-icon">analytics</mat-icon>
            <h2>No model data yet</h2>
            <p>Model summaries will appear here once AI models are used and rated.</p>
          </mat-card-content>
        </mat-card>
        }
      </div>
    </mat-tab>
  </mat-tab-group>
</div>
}
