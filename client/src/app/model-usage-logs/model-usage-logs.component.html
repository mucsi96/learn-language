<div class="container">
  <h1>Model Usage Logs</h1>
  <p>Track AI model usage and costs across chat, image, and audio services.</p>

  @let dateOptions = availableDates();
  @let modelTypes = availableModelTypes;
  @let operationTypes = availableOperationTypes;

  <mat-tab-group>
    <mat-tab label="Usage Logs">
      <div class="tab-content">
        <div class="filters-section">
          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>Date</mat-label>
            <mat-select [value]="dateFilter()" (selectionChange)="onDateFilterChange($event.value)" aria-label="Filter by date">
              <mat-option value="ALL">All dates</mat-option>
              @for (option of dateOptions; track option.value) {
                <mat-option [value]="option.value">{{ option.label }}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>Type</mat-label>
            <mat-select [value]="modelTypeFilter()" (selectionChange)="onModelTypeFilterChange($event.value)" aria-label="Filter by type">
              <mat-option value="ALL">All types</mat-option>
              @for (type of modelTypes; track type) {
                <mat-option [value]="type">{{ type }}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>Operation</mat-label>
            <mat-select [value]="operationTypeFilter()" (selectionChange)="onOperationTypeFilterChange($event.value)" aria-label="Filter by operation">
              <mat-option value="ALL">All operations</mat-option>
              @for (op of operationTypes; track op) {
                <mat-option [value]="op">{{ op }}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          @if (canDelete()) {
          <button mat-icon-button
                  class="clear-logs-button"
                  (click)="clearLogs()"
                  aria-label="Clear logs"
                  matTooltip="Clear filtered logs">
            <mat-icon>delete_outline</mat-icon>
          </button>
          }
        </div>

        <ag-grid-angular
          class="usage-grid"
          [theme]="theme"
          [columnDefs]="columnDefs"
          [defaultColDef]="defaultColDef"
          [context]="gridContext"
          [rowModelType]="'infinite'"
          [cacheBlockSize]="100"
          [maxBlocksInCache]="10"
          [getRowId]="getRowId"
          (gridReady)="onGridReady($event)"
          (sortChanged)="onSortChanged($event)"
          (rowClicked)="onCellClicked($event)"
        />

        @let expandedLog = getExpandedLog();
        @if (expandedLog) {
        <div class="expanded-content">
          @if (expandedLog.responseContent) {
          @let diffLines = getDiffLines(expandedLog);
          <div class="content-section">
            <div class="content-header">
              @if (diffLines.length > 0) {
                <h3>Diff vs Primary</h3>
              } @else {
                <h3>Response</h3>
              }
              <button mat-icon-button
                      class="copy-button"
                      (click)="copyToClipboard(expandedLog.responseContent)"
                      aria-label="Copy to clipboard"
                      matTooltip="Copy to clipboard">
                <mat-icon>content_copy</mat-icon>
              </button>
            </div>
            @if (diffLines.length > 0) {
              <div class="content-pre diff-view">
                @for (line of diffLines; track $index) {
                  <div [class]="'diff-line diff-' + line.type">{{ line.type === 'added' ? '+' : line.type === 'removed' ? '-' : ' ' }} {{ line.content }}</div>
                }
              </div>
            } @else {
              <pre class="content-pre">{{ expandedLog.responseContent }}</pre>
            }
          </div>
          }
        </div>
        }
      </div>
    </mat-tab>

    <mat-tab label="Quota Limit Hits">
      <div class="tab-content">
        @let quotaDateOptions = quotaAvailableDates();
        @let quotaTypes = availableQuotaTypes;

        <div class="filters-section">
          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>Date</mat-label>
            <mat-select [value]="quotaDateFilter()" (selectionChange)="onQuotaDateFilterChange($event.value)" aria-label="Filter quota hits by date">
              <mat-option value="ALL">All dates</mat-option>
              @for (option of quotaDateOptions; track option.value) {
                <mat-option [value]="option.value">{{ option.label }}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>Quota Type</mat-label>
            <mat-select [value]="quotaTypeFilter()" (selectionChange)="onQuotaTypeFilterChange($event.value)" aria-label="Filter by quota type">
              <mat-option value="ALL">All types</mat-option>
              @for (type of quotaTypes; track type) {
                <mat-option [value]="type">{{ type }}</mat-option>
              }
            </mat-select>
          </mat-form-field>
        </div>

        <ag-grid-angular
          class="usage-grid"
          [theme]="theme"
          [columnDefs]="quotaColumnDefs"
          [defaultColDef]="defaultColDef"
          [rowModelType]="'infinite'"
          [cacheBlockSize]="100"
          [maxBlocksInCache]="10"
          [getRowId]="getRowId"
          (gridReady)="onQuotaGridReady($event)"
          (sortChanged)="onQuotaSortChanged($event)"
        />
      </div>
    </mat-tab>

    <mat-tab label="Model Summary">
      <div class="tab-content">
        @let groups = groupedSummary();
        @if (groups.length > 0) {
          @for (group of groups; track group.operationType) {
            <h3 class="operation-type-heading">{{ group.operationType }}</h3>
            <table mat-table [dataSource]="group.summaries" class="summary-table" [attr.aria-label]="group.operationType + ' summary'">
              <ng-container matColumnDef="modelName">
                <th mat-header-cell *matHeaderCellDef>Model</th>
                <td mat-cell *matCellDef="let row">
                  <span class="model-name">{{ row.modelName }}</span>
                </td>
              </ng-container>

              <ng-container matColumnDef="totalCalls">
                <th mat-header-cell *matHeaderCellDef>Total Calls</th>
                <td mat-cell *matCellDef="let row">{{ row.totalCalls }}</td>
              </ng-container>

              <ng-container matColumnDef="ratedCalls">
                <th mat-header-cell *matHeaderCellDef>Rated Calls</th>
                <td mat-cell *matCellDef="let row">{{ row.ratedCalls }}</td>
              </ng-container>

              <ng-container matColumnDef="averageRating">
                <th mat-header-cell *matHeaderCellDef>Avg Rating</th>
                <td mat-cell *matCellDef="let row">
                  @if (row.ratedCalls > 0) {
                    <div class="avg-rating">
                      <mat-icon class="star-filled">star</mat-icon>
                      <span>{{ row.averageRating | number: '1.2-2' }}</span>
                    </div>
                  } @else {
                    <span class="no-rating">-</span>
                  }
                </td>
              </ng-container>

              <ng-container matColumnDef="totalCost">
                <th mat-header-cell *matHeaderCellDef>Total Cost</th>
                <td mat-cell *matCellDef="let row">
                  <span class="cost-value">${{ row.totalCost | number: '1.4-4' }}</span>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="summaryColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: summaryColumns"></tr>
            </table>
          }
        } @else {
        <mat-card class="empty-state">
          <mat-card-content>
            <mat-icon class="empty-icon">analytics</mat-icon>
            <h2>No model data yet</h2>
            <p>Model summaries will appear here once AI models are used and rated.</p>
          </mat-card-content>
        </mat-card>
        }
      </div>
    </mat-tab>
  </mat-tab-group>
</div>
