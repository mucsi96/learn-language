CREATE SCHEMA IF NOT EXISTS learn_language;

CREATE TABLE IF NOT EXISTS learn_language.sources (
    id character varying(255) NOT NULL,
    bookmarked_page integer,
    start_page integer,
    name character varying(255),
    language_level character varying(255),
    card_type character varying(255),
    format_type character varying(255),
    CONSTRAINT sources_pkey PRIMARY KEY (id)
);

ALTER TABLE learn_language.sources DROP COLUMN IF EXISTS file_name;

ALTER TABLE learn_language.sources ADD COLUMN IF NOT EXISTS format_type character varying(255);
ALTER TABLE learn_language.sources ADD COLUMN IF NOT EXISTS source_type character varying(255);

CREATE TABLE IF NOT EXISTS learn_language.documents (
    id integer NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    source_id character varying(255) NOT NULL,
    file_name character varying(255) NOT NULL,
    page_number integer,
    CONSTRAINT documents_pkey PRIMARY KEY (id),
    CONSTRAINT document_source_id_fkey FOREIGN KEY (source_id) REFERENCES learn_language.sources(id) ON DELETE CASCADE
);

ALTER TABLE learn_language.documents ALTER COLUMN page_number DROP NOT NULL;

CREATE TABLE IF NOT EXISTS learn_language.cards (
    id character varying(255) NOT NULL,
    source_id character varying(255) NOT NULL,
    source_page_number integer NOT NULL,
    data jsonb NOT NULL,
    readiness character varying(255) NOT NULL,
    due timestamp(6) without time zone NOT NULL,
    stability real NOT NULL,
    difficulty real NOT NULL,
    elapsed_days real NOT NULL,
    scheduled_days real NOT NULL,
    learning_steps integer NOT NULL,
    reps integer NOT NULL,
    lapses integer NOT NULL,
    state character varying(255) NOT NULL,
    last_review timestamp(6) without time zone,
    CONSTRAINT cards_pkey PRIMARY KEY (id),
    CONSTRAINT card_source_id_fkey FOREIGN KEY (source_id) REFERENCES learn_language.sources(id)
);

CREATE TABLE IF NOT EXISTS learn_language.review_logs (
    id integer NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    rating integer NOT NULL,
    review_duration integer,
    review timestamp(6) without time zone NOT NULL,
    card_id character varying(255) NOT NULL,
    state character varying(255) NOT NULL,
    due timestamp(6) without time zone NOT NULL,
    stability double precision NOT NULL,
    difficulty double precision NOT NULL,
    elapsed_days double precision NOT NULL,
    last_elapsed_days double precision,
    scheduled_days double precision NOT NULL,
    learning_steps integer,
    learning_partner_id integer,
    CONSTRAINT review_logs_pkey PRIMARY KEY (id),
    CONSTRAINT review_log_card_id_fkey FOREIGN KEY (card_id) REFERENCES learn_language.cards(id)
);

-- Migration: Add missing columns if they don't exist
ALTER TABLE learn_language.review_logs ADD COLUMN IF NOT EXISTS state character varying(255);
ALTER TABLE learn_language.review_logs ADD COLUMN IF NOT EXISTS due timestamp(6) without time zone;
ALTER TABLE learn_language.review_logs ADD COLUMN IF NOT EXISTS stability double precision;
ALTER TABLE learn_language.review_logs ADD COLUMN IF NOT EXISTS difficulty double precision;
ALTER TABLE learn_language.review_logs ADD COLUMN IF NOT EXISTS elapsed_days double precision;
ALTER TABLE learn_language.review_logs ADD COLUMN IF NOT EXISTS last_elapsed_days double precision;
ALTER TABLE learn_language.review_logs ADD COLUMN IF NOT EXISTS scheduled_days double precision;
ALTER TABLE learn_language.review_logs ADD COLUMN IF NOT EXISTS learning_steps integer;
ALTER TABLE learn_language.review_logs ADD COLUMN IF NOT EXISTS learning_partner_id integer;

CREATE TABLE IF NOT EXISTS learn_language.model_usage_logs (
    id integer NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    model_name character varying(255) NOT NULL,
    model_type character varying(50) NOT NULL,
    operation_type character varying(255) NOT NULL,
    input_tokens bigint,
    output_tokens bigint,
    input_characters bigint,
    image_count integer,
    cost_usd numeric(10, 6),
    processing_time_ms bigint,
    response_content text,
    rating integer,
    created_at timestamp(6) without time zone NOT NULL,
    CONSTRAINT model_usage_logs_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS learn_language.voice_configurations (
    id integer NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    voice_id character varying(255) NOT NULL,
    model character varying(255) NOT NULL,
    language character varying(10) NOT NULL,
    display_name character varying(255),
    is_enabled boolean NOT NULL DEFAULT true,
    CONSTRAINT voice_configurations_pkey PRIMARY KEY (id),
    CONSTRAINT voice_configurations_unique UNIQUE (voice_id, language, model)
);

CREATE TABLE IF NOT EXISTS learn_language.chat_model_settings (
    id integer NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    model_name character varying(255) NOT NULL,
    operation_type character varying(255) NOT NULL,
    is_enabled boolean NOT NULL DEFAULT true,
    is_primary boolean NOT NULL DEFAULT false,
    CONSTRAINT chat_model_settings_pkey PRIMARY KEY (id),
    CONSTRAINT chat_model_settings_unique UNIQUE (model_name, operation_type)
);

CREATE TABLE IF NOT EXISTS learn_language.known_words (
    id integer NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    word character varying(255) NOT NULL,
    CONSTRAINT known_words_pkey PRIMARY KEY (id),
    CONSTRAINT known_words_unique UNIQUE (word)
);

CREATE TABLE IF NOT EXISTS learn_language.learning_partners (
    id integer NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    name character varying(255) NOT NULL,
    is_active boolean NOT NULL DEFAULT false,
    CONSTRAINT learning_partners_pkey PRIMARY KEY (id)
);

-- Add foreign key constraint for learning_partner_id
ALTER TABLE learn_language.review_logs DROP CONSTRAINT IF EXISTS review_log_learning_partner_fkey;
ALTER TABLE learn_language.review_logs ADD CONSTRAINT review_log_learning_partner_fkey
    FOREIGN KEY (learning_partner_id) REFERENCES learn_language.learning_partners(id) ON DELETE SET NULL;

CREATE TABLE IF NOT EXISTS learn_language.study_sessions (
    id character varying(255) NOT NULL,
    source_id character varying(255) NOT NULL,
    created_at timestamp(6) without time zone NOT NULL,
    study_mode character varying(50) NOT NULL DEFAULT 'SOLO',
    CONSTRAINT study_sessions_pkey PRIMARY KEY (id),
    CONSTRAINT study_session_source_fkey FOREIGN KEY (source_id) REFERENCES learn_language.sources(id) ON DELETE CASCADE
);

ALTER TABLE learn_language.study_sessions DROP COLUMN IF EXISTS current_index;

CREATE TABLE IF NOT EXISTS learn_language.study_session_cards (
    id integer NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    session_id character varying(255) NOT NULL,
    card_id character varying(255) NOT NULL,
    position integer NOT NULL,
    learning_partner_id integer,
    CONSTRAINT study_session_cards_pkey PRIMARY KEY (id),
    CONSTRAINT study_session_cards_session_fkey FOREIGN KEY (session_id) REFERENCES learn_language.study_sessions(id) ON DELETE CASCADE,
    CONSTRAINT study_session_cards_card_fkey FOREIGN KEY (card_id) REFERENCES learn_language.cards(id) ON DELETE CASCADE,
    CONSTRAINT study_session_cards_partner_fkey FOREIGN KEY (learning_partner_id) REFERENCES learn_language.learning_partners(id) ON DELETE SET NULL
);

ALTER TABLE learn_language.study_session_cards DROP COLUMN IF EXISTS is_completed;
